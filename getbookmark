#!/bin/bash

bookmarkFile="/media/projects/journal/logs/bookmarks.txt"
[ -f "$bookmarkFile" ] || {
    notify-send "bookmarks" "file not found"
    exit 1
}

# extract labels and map back to full lines
mapfile -t labels < <(
    awk -F'[][]' '
        match($0, /\[[^]]+\]/) {
            label = substr($0, RSTART + 1, RLENGTH - 2)
            if (length(label) > 155)
                label = substr(label, 1, 155) "...";
            print label
        }
    ' "$bookmarkFile"
)

# show in dmenu
selection=$(printf "%s\n" "${labels[@]}" | dmenu -i -l 10 -vi -p "GoTo:")

# exit if no selection
[ -z "$selection" ] && exit 0

# find the matching full line from the original file
fullLine=$(grep -F "[$selection]" "$bookmarkFile")

# extract url inside ( )
url=$(echo "$fullLine" | awk -F'[()]' '{print $(NF-1)}')

# notify and copy
notify-send "opening bookmark" "$url"
echo "$url" | xclip -selection clipboard
echo "$url" | xclip -selection primary

# open in browser if url found
[ -n "$url" ] && browser "$url"
